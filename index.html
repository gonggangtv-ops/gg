<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile LAN POS - XP80T</title>

<style>
body{font-family:sans-serif;background:#f4f4f4;margin:0;padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
input,button{padding:12px;margin:5px 0;width:100%;border-radius:8px;border:1px solid #ccc;font-size:16px}
button{background:#3f72af;color:white;border:none}
button.danger{background:#dc3545}
.status{font-size:14px;margin-top:5px}
.online{color:green}
.offline{color:red}
</style>
</head>
<body>

<div class="card">
<h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h3>
<input type="text" id="printer-ip" placeholder="192.168.1.xxx">
<button onclick="saveIP()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å IP</button>
<div id="status" class="status"></div>
</div>

<div class="card">
<h3>‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h3>
<input type="number" id="table" placeholder="‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà" value="1">
<input type="text" id="order" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
<button onclick="printBill()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
<button class="danger" onclick="testPrint()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå</button>
</div>

<script>

let printerIP = localStorage.getItem("xp_ip") || "";
if(printerIP){
    document.getElementById("printer-ip").value = printerIP;
    checkStatus();
}

function saveIP(){
    printerIP = document.getElementById("printer-ip").value.trim();
    localStorage.setItem("xp_ip", printerIP);
    checkStatus();
}

async function checkStatus(){
    const statusEl = document.getElementById("status");
    statusEl.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
    statusEl.className = "status";

    try{
        const controller = new AbortController();
        setTimeout(()=>controller.abort(),2000);

        await fetch(`http://${printerIP}/`,{
            method:"GET",
            mode:"no-cors",
            signal:controller.signal
        });

        statusEl.innerHTML = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ";
        statusEl.classList.add("online");

    }catch{
        statusEl.innerHTML = "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
        statusEl.classList.add("offline");
    }
}

function buildESC(table,order){

    let text = "";
    text += "\x1B\x40";          // init
    text += "\x1B\x61\x01";      // center
    text += "\x1D\x21\x11";      // double size
    text += "‡πÇ‡∏ï‡πä‡∏∞ "+table+"\n";
    text += "\x1D\x21\x00";      // normal
    text += "\x1B\x61\x00";      // left
    text += "----------------------\n";
    text += order+"\n";
    text += "----------------------\n\n";
    text += "\n\n\n";
    text += "\x1D\x56\x41\x03";  // cut

    return text;
}

function printBill(){

    if(!printerIP){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ IP ‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const table = document.getElementById("table").value;
    const order = document.getElementById("order").value;

    const data = buildESC(table,order);

    fetch(`http://${printerIP}/cgi-bin/print`,{
        method:"POST",
        mode:"no-cors",
        body:data
    });

    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß");
}

function testPrint(){

    if(!printerIP){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ IP ‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const data = "\x1B\x40TEST PRINT\nXP-80T ONLINE\n\n\n\x1D\x56\x41\x03";

    fetch(`http://${printerIP}/cgi-bin/print`,{
        method:"POST",
        mode:"no-cors",
        body:data
    });

    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
}

</script>

</body>
</html>
